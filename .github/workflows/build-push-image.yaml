name: CI/CD Pipeline for Codexray

# -------------------------------------
# Triggers: Run on push to main branch
# -------------------------------------
on:
  push:
    branches:
      - main

# -------------------------------------
# Define Environment Variables
# -------------------------------------
env:
  GCR_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/codexray-node-agent:latest
  GKE_CLUSTER: codexray-cluster
  GKE_REGION: asia-south1
  GKE_NAMESPACE: codexray

permissions:
  id-token: write   # Required for Workload Identity Federation
  contents: read    # Required for accessing repository contents

# -------------------------------------
# Job 1: CI - Build, Test, Lint
# -------------------------------------
jobs:

# -------------------------------------
# Job 2: Build and Push Docker Image to GCR
# -------------------------------------
  build-and-push:
    name: Build and Push Docker Image to GCR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3


      # Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate with Workload Identity Federation
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      # Set up gcloud CLI
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: 'latest'

      # Configure Docker to use GCR
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker --quiet

      # Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t $GCR_IMAGE -f Dockerfile .

      # Push Docker Image to GCR
      - name: Push Docker Image to GCR
        run: |
          docker push $GCR_IMAGE

